-- =====================================================
-- Analytics Suite: Revenue Predictions Table
-- Created: 2025-01-18
-- Purpose: Store predictive trend analysis results
-- =====================================================

-- Create revenue_predictions table
CREATE TABLE IF NOT EXISTS revenue_predictions (
    prediction_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    
    -- Prediction metadata
    prediction_date DATE NOT NULL,
    predicted_month DATE NOT NULL,
    
    -- Prediction values
    predicted_revenue DECIMAL(12, 2) NOT NULL,
    confidence_level DECIMAL(5, 2), -- 0-100 percentage
    prediction_method VARCHAR(50) DEFAULT 'linear_regression',
    
    -- Historical context
    historical_data_points INTEGER,
    avg_historical_revenue DECIMAL(12, 2),
    
    -- Model parameters (JSON for flexibility)
    model_parameters JSONB,
    
    -- Accuracy tracking (after actual month completes)
    actual_revenue DECIMAL(12, 2),
    accuracy_percentage DECIMAL(5, 2),
    
    -- Metadata
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    
    -- Constraints
    CONSTRAINT unique_prediction_per_month UNIQUE (predicted_month, prediction_date),
    CONSTRAINT valid_confidence CHECK (confidence_level >= 0 AND confidence_level <= 100),
    CONSTRAINT valid_accuracy CHECK (accuracy_percentage IS NULL OR 
                                     (accuracy_percentage >= 0 AND accuracy_percentage <= 100))
);

-- Create index for efficient querying
CREATE INDEX idx_revenue_predictions_month ON revenue_predictions(predicted_month);
CREATE INDEX idx_revenue_predictions_date ON revenue_predictions(prediction_date);

-- Enable RLS
ALTER TABLE revenue_predictions ENABLE ROW LEVEL SECURITY;

-- RLS Policies - CEO, MD, SysAdmin can read predictions
CREATE POLICY "Analytics predictions visible to executives"
ON revenue_predictions
FOR SELECT
TO authenticated
USING (
    EXISTS (
        SELECT 1 FROM profiles
        WHERE profiles.user_id = auth.uid()
        AND profiles.role IN ('CEO', 'MD', 'SysAdmin')
    )
);

-- RLS Policy - System can insert/update predictions
CREATE POLICY "System can manage predictions"
ON revenue_predictions
FOR ALL
TO service_role
USING (true)
WITH CHECK (true);

-- Create function to update accuracy after month completes
CREATE OR REPLACE FUNCTION update_prediction_accuracy()
RETURNS void
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
BEGIN
    UPDATE revenue_predictions rp
    SET 
        actual_revenue = rt.total_revenue,
        accuracy_percentage = 100 - ABS((rp.predicted_revenue - rt.total_revenue) / NULLIF(rt.total_revenue, 0) * 100),
        updated_at = NOW()
    FROM revenue_trends_summary rt
    WHERE 
        DATE_TRUNC('month', rt.month) = rp.predicted_month
        AND rp.actual_revenue IS NULL
        AND rt.month < DATE_TRUNC('month', CURRENT_DATE); -- Only completed months
END;
$$;

-- Grant permissions
GRANT SELECT ON revenue_predictions TO authenticated;
GRANT ALL ON revenue_predictions TO service_role;

COMMENT ON TABLE revenue_predictions IS 'Stores predictive revenue forecasts generated by analytics engine';
COMMENT ON FUNCTION update_prediction_accuracy() IS 'Updates prediction accuracy after actual month data is available';
